rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      match /keys/{email} {
        match /tokens/{code} {
            allow list: if request.auth.token.email == email
            allow get: if (request.time - resource.data.uploadTime) <= duration.value(60, 's')
            allow create: if request.auth.token.email == email && request.resource.data.keys().hasAll(["uploadTime", "token"]) && request.time >= request.resource.data.uploadTime
            allow delete: if request.auth.token.email == email
        }
      }
    }
  }
}